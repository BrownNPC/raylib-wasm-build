#!/bin/bash

# this is intended to run inside emscripten/emsdk docker

mkdir -p build

if [ ! -d "include" ];then
	wget https://github.com/raysan5/raylib/releases/download/4.5.0/raylib-4.5.0_webassembly.zip
	unzip raylib-4.5.0_webassembly.zip
	mv raylib-4.5.0_webassembly/lib raylib-4.5.0_webassembly/include .
	rm -rf raylib-4.5.0_webassembly raylib-4.5.0_webassembly.zip
fi

emcc raylib.c lib/libraylib.a -o build/raylib_wasm.js -I include --no-entry -DPLATFORM_WEB -Os \
	-sEXPORT_KEEPALIVE=1 \
	-sEXPORT_ES6=1 \
	-sALLOW_MEMORY_GROWTH=1 \
	-sASYNCIFY \
	-sUSE_GLFW=3 \
	-sEXPORTED_FUNCTIONS=_malloc,_free,_InitWindow,_WindowShouldClose,_CloseWindow,_IsWindowReady,_IsWindowFullscreen,_IsWindowHidden,_IsWindowMinimized,_IsWindowMaximized,_IsWindowFocused,_IsWindowResized,_IsWindowState,_SetWindowState,_ClearWindowState,_ToggleFullscreen,_MaximizeWindow,_MinimizeWindow,_RestoreWindow,_SetWindowIcon,_SetWindowIcons,_SetWindowTitle,_SetWindowPosition,_SetWindowMonitor,_SetWindowMinSize,_SetWindowSize,_SetWindowOpacity,_GetWindowHandle,_GetScreenWidth,_GetScreenHeight,_GetRenderWidth,_GetRenderHeight,_GetMonitorCount,_GetCurrentMonitor,_GetMonitorPosition,_GetMonitorWidth,_GetMonitorHeight,_GetMonitorPhysicalWidth,_GetMonitorPhysicalHeight,_GetMonitorRefreshRate,_GetWindowPosition,_GetWindowScaleDPI,_GetMonitorName,_SetClipboardText,_GetClipboardText,_EnableEventWaiting,_DisableEventWaiting,_SwapScreenBuffer,_PollInputEvents,_WaitTime,_ShowCursor,_HideCursor,_IsCursorHidden,_EnableCursor,_DisableCursor,_IsCursorOnScreen,_ClearBackground,_BeginDrawing,_EndDrawing,_BeginMode2D,_EndMode2D,_BeginMode3D,_EndMode3D,_BeginTextureMode,_EndTextureMode,_BeginShaderMode,_EndShaderMode,_BeginBlendMode,_EndBlendMode,_BeginScissorMode,_EndScissorMode,_BeginVrStereoMode,_EndVrStereoMode,_LoadVrStereoConfig,_UnloadVrStereoConfig,_LoadShader,_LoadShaderFromMemory,_IsShaderReady,_GetShaderLocation,_GetShaderLocationAttrib,_SetShaderValue,_SetShaderValueV,_SetShaderValueMatrix,_SetShaderValueTexture,_UnloadShader,_GetMouseRay,_GetCameraMatrix,_GetCameraMatrix2D,_GetWorldToScreen,_GetScreenToWorld2D,_GetWorldToScreenEx,_GetWorldToScreen2D,_SetTargetFPS,_GetFPS,_GetFrameTime,_GetTime,_GetRandomValue,_SetRandomSeed,_TakeScreenshot,_SetConfigFlags,_TraceLog,_SetTraceLogLevel,_MemAlloc,_MemRealloc,_MemFree,_OpenURL,_SetTraceLogCallback,_SetLoadFileDataCallback,_SetSaveFileDataCallback,_SetLoadFileTextCallback,_SetSaveFileTextCallback,_LoadFileData,_UnloadFileData,_SaveFileData,_ExportDataAsCode,_LoadFileText,_UnloadFileText,_SaveFileText,_FileExists,_DirectoryExists,_IsFileExtension,_GetFileLength,_GetFileExtension,_GetFileName,_GetFileNameWithoutExt,_GetDirectoryPath,_GetPrevDirectoryPath,_GetWorkingDirectory,_GetApplicationDirectory,_ChangeDirectory,_IsPathFile,_LoadDirectoryFiles,_LoadDirectoryFilesEx,_UnloadDirectoryFiles,_IsFileDropped,_LoadDroppedFiles,_UnloadDroppedFiles,_GetFileModTime,_CompressData,_DecompressData,_EncodeDataBase64,_DecodeDataBase64,_IsKeyPressed,_IsKeyDown,_IsKeyReleased,_IsKeyUp,_SetExitKey,_GetKeyPressed,_GetCharPressed,_IsGamepadAvailable,_GetGamepadName,_IsGamepadButtonPressed,_IsGamepadButtonDown,_IsGamepadButtonReleased,_IsGamepadButtonUp,_GetGamepadButtonPressed,_GetGamepadAxisCount,_GetGamepadAxisMovement,_SetGamepadMappings,_IsMouseButtonPressed,_IsMouseButtonDown,_IsMouseButtonReleased,_IsMouseButtonUp,_GetMouseX,_GetMouseY,_GetMousePosition,_GetMouseDelta,_SetMousePosition,_SetMouseOffset,_SetMouseScale,_GetMouseWheelMove,_GetMouseWheelMoveV,_SetMouseCursor,_GetTouchX,_GetTouchY,_GetTouchPosition,_GetTouchPointId,_GetTouchPointCount,_SetGesturesEnabled,_IsGestureDetected,_GetGestureDetected,_GetGestureHoldDuration,_GetGestureDragVector,_GetGestureDragAngle,_GetGesturePinchVector,_GetGesturePinchAngle,_UpdateCamera,_UpdateCameraPro,_SetShapesTexture,_DrawPixel,_DrawPixelV,_DrawLine,_DrawLineV,_DrawLineEx,_DrawLineBezier,_DrawLineBezierQuad,_DrawLineBezierCubic,_DrawLineStrip,_DrawCircle,_DrawCircleSector,_DrawCircleSectorLines,_DrawCircleGradient,_DrawCircleV,_DrawCircleLines,_DrawEllipse,_DrawEllipseLines,_DrawRing,_DrawRingLines,_DrawRectangle,_DrawRectangleV,_DrawRectangleRec,_DrawRectanglePro,_DrawRectangleGradientV,_DrawRectangleGradientH,_DrawRectangleGradientEx,_DrawRectangleLines,_DrawRectangleLinesEx,_DrawRectangleRounded,_DrawRectangleRoundedLines,_DrawTriangle,_DrawTriangleLines,_DrawTriangleFan,_DrawTriangleStrip,_DrawPoly,_DrawPolyLines,_DrawPolyLinesEx,_CheckCollisionRecs,_CheckCollisionCircles,_CheckCollisionCircleRec,_CheckCollisionPointRec,_CheckCollisionPointCircle,_CheckCollisionPointTriangle,_CheckCollisionPointPoly,_CheckCollisionLines,_CheckCollisionPointLine,_GetCollisionRec,_LoadImage,_LoadImageRaw,_LoadImageAnim,_LoadImageFromMemory,_LoadImageFromTexture,_LoadImageFromScreen,_IsImageReady,_UnloadImage,_ExportImage,_ExportImageAsCode,_GenImageColor,_GenImageGradientRadial,_GenImageChecked,_GenImageWhiteNoise,_GenImagePerlinNoise,_GenImageCellular,_GenImageText,_ImageCopy,_ImageFromImage,_ImageText,_ImageTextEx,_ImageFormat,_ImageToPOT,_ImageCrop,_ImageAlphaCrop,_ImageAlphaClear,_ImageAlphaMask,_ImageAlphaPremultiply,_ImageBlurGaussian,_ImageResize,_ImageResizeNN,_ImageResizeCanvas,_ImageMipmaps,_ImageDither,_ImageFlipVertical,_ImageFlipHorizontal,_ImageRotateCW,_ImageRotateCCW,_ImageColorTint,_ImageColorInvert,_ImageColorGrayscale,_ImageColorContrast,_ImageColorBrightness,_ImageColorReplace,_LoadImageColors,_LoadImagePalette,_UnloadImageColors,_UnloadImagePalette,_GetImageAlphaBorder,_GetImageColor,_ImageClearBackground,_ImageDrawPixel,_ImageDrawPixelV,_ImageDrawLine,_ImageDrawLineV,_ImageDrawCircle,_ImageDrawCircleV,_ImageDrawCircleLines,_ImageDrawCircleLinesV,_ImageDrawRectangle,_ImageDrawRectangleV,_ImageDrawRectangleRec,_ImageDrawRectangleLines,_ImageDraw,_ImageDrawText,_ImageDrawTextEx,_LoadTexture,_LoadTextureFromImage,_LoadTextureCubemap,_LoadRenderTexture,_IsTextureReady,_UnloadTexture,_IsRenderTextureReady,_UnloadRenderTexture,_UpdateTexture,_UpdateTextureRec,_GenTextureMipmaps,_SetTextureFilter,_SetTextureWrap,_DrawTexture,_DrawTextureV,_DrawTextureEx,_DrawTextureRec,_DrawTexturePro,_DrawTextureNPatch,_Fade,_ColorToInt,_ColorNormalize,_ColorFromNormalized,_ColorToHSV,_ColorFromHSV,_ColorTint,_ColorBrightness,_ColorContrast,_ColorAlpha,_ColorAlphaBlend,_GetColor,_GetPixelColor,_SetPixelColor,_GetPixelDataSize,_GetFontDefault,_LoadFont,_LoadFontEx,_LoadFontFromImage,_LoadFontFromMemory,_IsFontReady,_LoadFontData,_GenImageFontAtlas,_UnloadFontData,_UnloadFont,_ExportFontAsCode,_DrawFPS,_DrawText,_DrawTextEx,_DrawTextPro,_DrawTextCodepoint,_DrawTextCodepoints,_MeasureText,_MeasureTextEx,_GetGlyphIndex,_GetGlyphInfo,_GetGlyphAtlasRec,_LoadUTF8,_UnloadUTF8,_LoadCodepoints,_UnloadCodepoints,_GetCodepointCount,_GetCodepoint,_GetCodepointNext,_GetCodepointPrevious,_CodepointToUTF8,_TextCopy,_TextIsEqual,_TextLength,_TextFormat,_TextSubtext,_TextReplace,_TextInsert,_TextJoin,_TextSplit,_TextAppend,_TextFindIndex,_TextToUpper,_TextToLower,_TextToPascal,_TextToInteger,_DrawLine3D,_DrawPoint3D,_DrawCircle3D,_DrawTriangle3D,_DrawTriangleStrip3D,_DrawCube,_DrawCubeV,_DrawCubeWires,_DrawCubeWiresV,_DrawSphere,_DrawSphereEx,_DrawSphereWires,_DrawCylinder,_DrawCylinderEx,_DrawCylinderWires,_DrawCylinderWiresEx,_DrawCapsule,_DrawCapsuleWires,_DrawPlane,_DrawRay,_DrawGrid,_LoadModel,_LoadModelFromMesh,_IsModelReady,_UnloadModel,_GetModelBoundingBox,_DrawModel,_DrawModelEx,_DrawModelWires,_DrawModelWiresEx,_DrawBoundingBox,_DrawBillboard,_DrawBillboardRec,_DrawBillboardPro,_UploadMesh,_UpdateMeshBuffer,_UnloadMesh,_DrawMesh,_DrawMeshInstanced,_ExportMesh,_GetMeshBoundingBox,_GenMeshTangents,_GenMeshPoly,_GenMeshPlane,_GenMeshCube,_GenMeshSphere,_GenMeshHemiSphere,_GenMeshCylinder,_GenMeshCone,_GenMeshTorus,_GenMeshKnot,_GenMeshHeightmap,_GenMeshCubicmap,_LoadMaterials,_LoadMaterialDefault,_IsMaterialReady,_UnloadMaterial,_SetMaterialTexture,_SetModelMeshMaterial,_LoadModelAnimations,_UpdateModelAnimation,_UnloadModelAnimation,_UnloadModelAnimations,_IsModelAnimationValid,_CheckCollisionSpheres,_CheckCollisionBoxes,_CheckCollisionBoxSphere,_GetRayCollisionSphere,_GetRayCollisionBox,_GetRayCollisionMesh,_GetRayCollisionTriangle,_GetRayCollisionQuad,_InitAudioDevice,_CloseAudioDevice,_IsAudioDeviceReady,_SetMasterVolume,_LoadWave,_LoadWaveFromMemory,_IsWaveReady,_LoadSound,_LoadSoundFromWave,_IsSoundReady,_UpdateSound,_UnloadWave,_UnloadSound,_ExportWave,_ExportWaveAsCode,_PlaySound,_StopSound,_PauseSound,_ResumeSound,_IsSoundPlaying,_SetSoundVolume,_SetSoundPitch,_SetSoundPan,_WaveCopy,_WaveCrop,_WaveFormat,_LoadWaveSamples,_UnloadWaveSamples,_LoadMusicStream,_LoadMusicStreamFromMemory,_IsMusicReady,_UnloadMusicStream,_PlayMusicStream,_IsMusicStreamPlaying,_UpdateMusicStream,_StopMusicStream,_PauseMusicStream,_ResumeMusicStream,_SeekMusicStream,_SetMusicVolume,_SetMusicPitch,_SetMusicPan,_GetMusicTimeLength,_GetMusicTimePlayed,_LoadAudioStream,_IsAudioStreamReady,_UnloadAudioStream,_UpdateAudioStream,_IsAudioStreamProcessed,_PlayAudioStream,_PauseAudioStream,_ResumeAudioStream,_IsAudioStreamPlaying,_StopAudioStream,_SetAudioStreamVolume,_SetAudioStreamPitch,_SetAudioStreamPan,_SetAudioStreamBufferSizeDefault,_SetAudioStreamCallback,_AttachAudioStreamProcessor,_DetachAudioStreamProcessor,_AttachAudioMixedProcessor,_DetachAudioMixedProcessor \
	-sEXPORTED_RUNTIME_METHODS=cwrap,allocateUTF8,stringToUTF8,UTF8ToString,FS,setValue,getValue \
	-sENVIRONMENT=web